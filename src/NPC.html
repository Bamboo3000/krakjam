<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
    <title>Phaser - Making your first game, part 9</title>
    <script src="//cdn.jsdelivr.net/phaser/2.2.2/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var gameWidth = 500;
var gameHeight = 400;
var screenWidth = 1024;
var screenHeight = 768;
var game = new Phaser.Game(screenWidth, screenHeight, Phaser.AUTO, '', { preload: preload, create: create, update: update });

function preload() {
    game.load.spritesheet('dude', 'dude.png', 32, 48);

}

var player;
var score = 0;
var scoreText;
var speed = 3;
var timer;

function circle(t){
    t = t/1000;
    return[Math.sin(t)*gameWidth/2+screenWidth/2, Math.cos(t)*gameHeight/2+screenHeight/2];
}

function twoStep(t){
    return square(1000*Math.sin(t/300)+t);
}



function square(t){
    var period = 5000;
    t%=4*period;
    var phase = t%period;
    phase/=period;
    phase-=0.5;
    phase*=2;
    
    var retX, retY;
    if(t<period){
        retX = phase;
        retY = 1;
    }
    else if(t<2*period){
        retX = 1;
        retY = -phase;
    }
    else if(t<3*period){
        retX = -phase;
        retY = -1;
    }
    else{
        retX = -1;
        retY = phase;
    }
    
    retX*=gameWidth/2;
    retX+=screenWidth/2;

    retY*=gameHeight/2;
    retY+=screenHeight/2;

    return[retX, retY];
}

function smooth(val){
    if(val<100)
        return val/1000;
    else 
        return 0.1;
}

function updateNPC(NPC){
    var v = {x :null,  y :null};
    v.x = NPC.update(timer.ms+NPC.shift)[0] - NPC.body.x;
    v.y = NPC.update(timer.ms+NPC.shift)[1] - NPC.body.y;
    var len = Math.sqrt(v.x*v.x+v.y*v.y);
    v.x/=len;
    v.y/=len;
    NPC.body.x += v.x*timer.elapsed*speed*smooth(len);//smooth(len*len);
    NPC.body.y += v.y*timer.elapsed*speed*smooth(len);//smooth(len*len);
}

function makeNPC(posX, posY, formation, shift, spriteName){
    var NPC;
    NPC = game.add.sprite(posX, posY, spriteName);
    NPC.update = formation;
    NPC.shift = shift;
    game.physics.arcade.enable(NPC);
    return NPC;
}
 

var NPCarray = [];
function create() {
    timer = game.time.create(false);
    timer.start();
    //  A simple background for our game
    // The player and its settings
    for (var i = 0; i < 12; i++){
        NPCarray[i] = makeNPC(Math.random()*gameWidth, Math.random()*gameHeight, twoStep, 1500*i, 'dude');
    }

}


function update() {
    for (var i = 0; i < 12; i++){
       updateNPC(NPCarray[i]);
    }

}

</script>

</body>
</html>